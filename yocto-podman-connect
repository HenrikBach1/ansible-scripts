#!/bin/bash
# Podman-compatible Yocto container connection script
# Uses unified container-shell-setup.sh for all functionality

CONTAINER_NAME="${1:-yocto_container_podman}"

# Check if container exists
if ! podman ps -a --format '{{.Names}}' | grep -w "^$CONTAINER_NAME$" > /dev/null; then
    echo "Container '$CONTAINER_NAME' does not exist"
    echo "Try running: ./start-yocto-container-podman.sh"
    exit 1
fi

# Check if container is running
if ! podman ps --format '{{.Names}}' | grep -w "^$CONTAINER_NAME$" > /dev/null; then
    echo "Container '$CONTAINER_NAME' is not running"
    echo "Starting container..."
    podman start "$CONTAINER_NAME"
    sleep 1
fi

# Check if container environment is set up, if not run setup
if ! podman exec "$CONTAINER_NAME" test -f "/usr/local/bin/container-help" 2>/dev/null; then
    echo "Container environment not found, setting up..."
    
    # Copy the unified setup script to container
    podman cp "$(dirname "$0")/container-shell-setup.sh" "$CONTAINER_NAME:/tmp/container-shell-setup.sh"
    
    # Run the setup script inside the container as root to ensure system-wide installation
    podman exec -u root "$CONTAINER_NAME" bash /tmp/container-shell-setup.sh
    
    # Also run as regular user to set up user-specific files (.shrc, etc.)
    podman exec "$CONTAINER_NAME" bash /tmp/container-shell-setup.sh
else
    echo "Container environment already configured."
fi

# Connect to container with enhanced environment
echo "Connecting to $CONTAINER_NAME..."
podman exec -it "$CONTAINER_NAME" bash -c "
# Source the shell environment (for immediate use)
export PATH=\"\$HOME/bin:/tmp/.container_commands:\$PATH\"

# Set proper prompt
if [ -n \"\$BASH_VERSION\" ]; then
    export PS1=\"\\[\\033[01;32m\\]\\u@\\[\\033[00m\\]\\[\\033[01;33m\\](yocto-podman)\\[\\033[00m\\]:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ \"
fi

# Set up convenient aliases
alias detach='container-detach'
alias stop='container-stop'
alias help='container-help'

# Show initial help
echo \"Welcome to the Yocto Container (Podman)!\"
echo \"Enhanced environment with container commands available.\"
echo \"Type 'help' or 'container-help' for available commands.\"
echo \"\"

# Start interactive shell
exec bash -l
"
